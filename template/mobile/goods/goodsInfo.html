<!DOCTYPE html>
<html>
<head>
    <title>商品详情-{$tpshop_config['shop_info_store_title']}</title>
    <link href="__STATIC__/css/bootstrap.css" rel="stylesheet" type="text/css" media="all" />
    <link href="__STATIC__/css/swiper-4.2.2.min.css" rel="stylesheet" type="text/css" media="all" />
    <link href="__STATIC__/css/normalize.css" rel="stylesheet" type="text/css" media="all" />

    <link href="http://cdn.bootcss.com/photoswipe/4.1.1/photoswipe.css" rel="stylesheet">
    <link href="http://cdn.bootcss.com/photoswipe/4.1.1/default-skin/default-skin.css" rel="stylesheet">

    <link href="__STATIC__/css/style.css?v=2" rel="stylesheet" type="text/css" media="all" />
    <link href="__STATIC__/css/p-common.css" rel="stylesheet" type="text/css" media="all" />
    <link href="__STATIC__/css/detail_y.css" rel="stylesheet" type="text/css" media="all" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,initial-scale=1,user-scalable=no" />
</head>
<style>
    .slider-nav{
        z-index: 10;
    }
.pswp__counter{
   display: none;
}

.img_shadow{
    position: fixed;
    bottom: 51px;
    top: auto;
    height: 35px;
    background-image: none;
    text-align: center;
    background-color: #6f6f6f;
    line-height: 35px;
    color: #fff;
}
.goods-img ul {padding: 0;}
</style>
<body>
<!--header-s-->
<div class="mobel-header">
    <div class="back" onClick="javascript:history.back(-1);"> </div>
    <div class="logo">
        <img src="__STATIC__/image/icon/logo.png" alt="">
    </div>
</div>
<!--header-e-->
<div class="main_content detailsPage">
    <div class="swiper-container">
    <div class="swiper-wrapper my-gallery">
    <foreach name="goods_images_list" item="v" key="k" >
        <figure class="swiper-slide">
        <div>
        <a href="{$v|get_sub_images=$v[goods_id],800,800}" data-size="414x414">
        <img src="{$v|get_sub_images=$v[goods_id],800,800}" alt="">
        </a>
        </div>
        </figure>
    </foreach>
    </div>
        <div class="swiper-pagination"></div>
        <if condition="$goods['temai'] eq 1"/>
            <div class='temaiIcon'><img src="__STATIC__/image/icon/temai.png" alt=""></div>
        </if>
    </div>

    <!--以下内容不要管-->
    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="pswp__bg"></div>
        <div class="pswp__scroll-wrap">
            <div class="pswp__container">
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
            </div>
            <div class="pswp__ui pswp__ui--hidden">
                <div class="pswp__top-bar">
                    <div class="pswp__counter"></div>
                    <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                    <div class="pswp__preloader">
                        <div class="pswp__preloader__icn">
                            <div class="pswp__preloader__cut">
                                <div class="pswp__preloader__donut"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                    <div class="pswp__share-tooltip"></div>
                </div>
                <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
                <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>
                <div class="pswp__caption">
                    <div class="pswp__caption__center"></div>
                </div>
            </div>
        </div>
    </div>
    <!---->
    <form name="buy_goods_form" method="post" id="buy_goods_form">
        <input type="hidden" name="goods_id" value="{$goods.goods_id}"><!-- 商品id -->
        <input type="hidden" name="activity_is_on" value="{$goods.activity_is_on}"><!-- 活动是否进行中 -->
        <input type="hidden" name="goods_prom_type" value="{$goods.prom_type}"/><!-- 活动类型 -->
        <input type="hidden" name="shop_price" value="{$goods.shop_price}"/><!-- 活动价格 -->
        <input type="hidden" name="store_count" value="{$goods.store_count}"/><!-- 活动库存 -->
        <input type="hidden" name="market_price" value="{$goods.market_price}"/><!-- 商品原价 -->
        <input type="hidden" name="start_time" value="{$goods.start_time}"/><!-- 活动开始时间 -->
        <input type="hidden" name="end_time" value="{$goods.end_time}"/><!-- 活动结束时间 -->
        <input type="hidden" name="activity_title" value="{$goods.activity_title}"/><!-- 活动标题 -->
        <input type="hidden" name="item_id" value="{$Request.param.item_id}"/><!-- 商品规格id -->
        <input type="hidden" name="prom_id" value="{$goods.prom_id}"/><!-- 活动ID -->
        <input type="hidden" name="exchange_integral" value="{$goods.exchange_integral}"/><!-- 积分 -->
        <input type="hidden" name="point_rate" value="{$point_rate}"/><!-- 积分兑换比 -->
        <input type="hidden" name="is_virtual" value="{$goods.is_virtual}"/><!-- 是否是虚拟商品 -->

        <!-- <input type="hidden" class="num buyNum" id="number" residuenum="{$goods.store_count}" name="goods_num" value="1" min="1" max="{$goods.store_count}"> -->
        <div class="choose_shop_aready p">
            <!--商品信息-s-->
            <div class="shop-top-under p">
                <div class="maleri30">
                    <div class="shopprice">
                        <div class="img_or fl"><img id="zoomimg" src="{$goods.original_img}"></div>
                        <div class="fon_or fl">
                            <h2 class="similar-product-text">{$goods.goods_name}</h2>
                            <input type="hidden" id="goods_name" name="goods_id" value="{$goods.goods_id}">
                            <div class="price_or" id="goods_price"><span>￥</span><span>{$goods.shop_price}</span></div>
                            <div class="dqkc_or"><span>剩余库存：</span><span id="spec_store_count">{$goods.store_count}</span></div>
                        </div>
                        <div class="price_or fr">
                            <i class="xxgro"></i>
                        </div>
                    </div>
                </div>
            </div>
            <!--商品信息-e-->
            <div class="shop-top-under p">
                <div class="maleri30">
                    <div class="shulges p" style="display: none;">
                        <p>数量</p>
                        <!--选择数量-->
                        <div class="plus">
                            <span class="mp_minous" onclick="altergoodsnum(-1);">-</span>
                                    <span class="mp_mp">
                            <input type="tel" class="num buyNum" id="number" residuenum="{$goods.store_count}" name="goods_num" value="1" min="1" max="{$goods.store_count}" onblur="altergoodsnum(0)">
                                    </span>
                            <span class="mp_plus" onclick="altergoodsnum(1);">+</span>
                        </div>
                    </div>
                    <if condition="$filter_spec neq ''">
                    <foreach item="spec" key="key" name="filter_spec">
                    <div class="shulges p choicsel" >
                        <p>{$key}</p>
                        <!-------商品属性值-s------->
                        <div class="plus choic-sel">
                        <foreach name="spec" item="v2" key="k2">
                            <a id="goods_spec_a_{$v2[item_id]}" title="{$v2[item]}"
                               onclick="switch_spec(this); <if condition="!empty($v2['src'])" >$('#zoomimg').attr('src','{$v2[src]}');</if>">
                            <input id="goods_spec_{$v2[item_id]}" type="radio" style="display:none;" name="goods_spec[{$key}]" value="{$v2[item_id]}"/>{$v2[item]}</a>
                        </foreach>
                        </div>
                        <!-------商品属性值-e-------->
                    </div>
                    </foreach>
                    </if>
                </div>
            </div>

            <div class="btns-fixed-wrap">
                <div class="plusshopcar-buy p btns-fixed-w100">
                    <a class="pb_plusshopcar button active_button dis_btn" href="javascript:void(0);" onClick="AjaxAddCart({$goods.goods_id},1);">加入购物车</a>
                    <a class="pb_buy dis_btn" href="javascript:void(0);"  onclick="buy_now();">立即购买 </a>
                </div>
            </div>
        </div>
    </form>
    <div class="goods-detail">
        <div class="detail goods-para">
            <p class="nprice title">￥<span class="price"><?php echo $goods['shop_price'] == '0.00'?'暂无': number_format($goods['shop_price']); ?></p>
            <p class="oprice">价格<span>￥<?php echo $goods['market_price'] == '0.00'?'暂无': number_format($goods['market_price']); ?></span></p>
            <p class="brand"><span>{$goods.goods_brand}</span>{$goods.goods_name}</p>
            <if condition="$goods['goods_remark']"><p class="deta">{$goods.goods_remark}</p></if>
        </div>
        <div>
        <div class="detail goods-info">
            <p class="title">商品信息</p>
            <ul>
                <foreach name="goods_attr_list" item="v" key="k">
                    <li><span class="name">{$v[attr_name]}</span><i class="namevalue">{$v[attr_value]}</i></li>
                </foreach>

            </ul>
        </div>
        <div class="detail goods-img">
            <p class="title">商品详情</p>
            <ul>
                {$goods.goods_content|htmlspecialchars_decode}
            </ul>
        </div>
    </div>
</div>

<!-- 加入购物袋 -->
  <div class="yshop">
    <ul class="yshop_ul">
      <li onClick="collect_goods({$goods.goods_id})">
        <div class="yshop_collect">
            <img class="yshow" src="<if condition='$collect gt 0'>__STATIC__image/add/xin.png<else/>__STATIC__image/add/xin1.png</if>">
        <p>收藏</p>
      </li>
      <li>
        <div><img src="__STATIC__image/add/kefu_y.png"></div>
        <p>客服</p>
      </li>
      <li onclick="window.location='{:U('mobile/cart/index')}'">
        <div style="position: relative;"><img src="__STATIC__image/add/dai_y.png"><span id="tp_cart_info" class="cartNum">0</span></div>
        <p>购物袋</p>
      </li>
    </ul>
   <!--  <button class="yshop_btn yshop_dai " onClick="AjaxAddCart({$goods.goods_id},1);">加入购物袋</button>
    <button class="yshop_btn yshop_buy choise_num"  onclick="buy_now();">立即购买</button> -->
    <button class="yshop_btn yshop_dai choise_num">加入购物袋</button>
    <button class="yshop_btn yshop_buy choise_num">立即购买</button>
  </div>
<if condition="$goods['reserved']==1">
    <div class='is_reserved'>该商品已预订</div>
    <elseif condition="$goods['store_count']<=0"/>
    <div class='img_shadow'>该商品已售罄</div>
</if>
<div class="mask-filter-div"></div>
<!--footer-e-->
</body>
<script src="__STATIC__/js/jquery.min.js"></script>
<script src="__STATIC__/js/swiper-4.2.2.min.js"></script>
<script src="http://cdn.bootcss.com/photoswipe/4.1.1/photoswipe.js"></script>
<script src="http://cdn.bootcss.com/photoswipe/4.1.1/photoswipe-ui-default.js"></script>
<script src="__STATIC__/js/type.js"></script>
<script src="__STATIC__/js/layer/layer.js"></script>
<script src="__STATIC__/js/cookie.js"></script>

<style type="text/css">
    .layui-layer-content {color: #FFF;}

    .temaiIcon{
        width: 60px;
        height: 60px;
        /*background: url('./template/mobile/static/image/icon/temai.png');*/
        position: absolute;
        right: 30px;
        bottom: 30px;
        z-index: 100
    }
    .temaiIcon img {width: 100%; height: 100%}

</style>
<script type="text/javascript">        
    var mySwiper = new Swiper ('.swiper-container', {
        autoplay: true,//可选选项，自动滑动
        loop: true,
        pagination: {
          el: '.swiper-pagination',
        },
    })  

    var spec_goods_price = {$spec_goods_price|default='null'};//规格库存价格
    console.log(spec_goods_price);
    //页面加载后执行
    $(document).ready(function () {
        ajax_header_cart();
        initSpec();
        initGoodsPrice();
    });

    function sortNumber(a,b)
    {
        return a - b;
    }

    //黑色遮罩层-隐藏
    function undercover(){
        $('.mask-filter-div').hide();
    }
    //黑色遮罩层-显示
    function cover(){
        $('.mask-filter-div').show();
    }

    //切换规格
    function switch_spec(spec) {

        $(spec).addClass('red').siblings().removeClass('red');
        $(spec).addClass('hover').siblings().removeClass('hover');
        $(spec).siblings().find('input').removeAttr('checked');
        $(spec).children('input').attr('checked', 'checked');
        //商品价格库存显示
        initGoodsPrice();
    }

    /**
     * 加入购物车、立即购买弹出属性选择层
     */
    $('.choise_num').click(function () {
        cover();
        $('.choose_shop_aready').show();
        $('.podee').hide();
    })

    //关闭属性选择
    $('.xxgro').click(function () {
        undercover();
        $('.choose_shop_aready').hide();
        $('.podee').show();
        sel();
    })

    //ajax请求购物车列表
    function ajax_header_cart(){

        $.ajax({
            type : "GET",
            url:"/index.php?m=Home&c=Cart&a=header_cart_list",//+tab,
            success: function(data){
             
                cart_cn = getCookie('cn');

                if(isNaN(cart_cn)) cart_cn = 0;
                $('#tp_cart_info').html(cart_cn);                  
            }
        }); 
        
    }

     /**
     * 立即购买
     */
    function buy_now(){
        var store_count = $("input[name='store_count']").attr('value');// 商品原始库存
        var buyNum = parseInt($("input[name='goods_num']").val());
        var goods_id = parseInt($("input[name='goods_id']").val());
        var item_id = $("input[name='item_id']").val();
        if (buyNum <= store_count) {
            location.href = "/index.php?m=Mobile&c=Cart&a=cart2&action=buy_now&goods_num="+buyNum+"&goods_id="+goods_id+"&item_id="+item_id;
        } else {
            layer.msg('购买数量超过此商品购买上限', {icon: 3});
        }
    }    

      //点击收藏商品
    function collect_goods(goods_id){

        $.ajax({
            type : "GET",
            dataType: "json",
            url:"/index.php?m=Home&c=goods&a=collect_goods",//+tab,
            data: {goods_id:goods_id},
            success: function(data){
                if(data.status == '1'){
                    layer.msg('收藏成功');
                    //收藏点亮
                    var xin = '__STATIC__image/add/xin.png';
                    $('.yshop_collect .yshow').attr('src', xin);
                }
                if(data.status == '-3'){
                    layer.msg('商品已收藏');
                }
            }
        });
    }

    /**
     * 将商品加入购物车
     * @param goods_id|商品id
     * @param num|商品数量
     * @constructor
     */
    function AjaxAddCart(goods_id, num) {

        $.ajax({
            type: "POST",
            url: "{:U('mobile/cart/ajaxAddCart')}",
            data: $("#buy_goods_form").serialize(),
            dataType: 'json',
            success: function (data) {
                if(data.status == 1){
                    layer.msg('加入购物车成功');
                    return false;
                }
                if (data.status <= 0) {
                    layer.msg(data.msg);
                    return false;
                }
            },
            error:function(){
                layer.msg('服务器错误');
            }
        });
    }

    //有规格id的时候，解析规格id选中规格
    function initSpec() {
        var item_id = $("input[name='item_id']").val();
        if (item_id > 0 && !$.isEmptyObject(spec_goods_price)) {
            var item_arr = [];
            $.each(spec_goods_price, function (i, o) {
                item_arr.push(o.item_id);
            })
            //规格id不存在商品里
            if ($.inArray(parseInt(item_id), item_arr) < 0) {
                initFirstSpec();
            } else {
                $.each(spec_goods_price, function (i, o) {
                    if (o.item_id == item_id) {
                        var spec_key_arr = o.key.split("_");
                        $.each(spec_key_arr, function (index, item) {
                            var spec_radio = $("#goods_spec_" + item);
                            var goods_spec_a = $("#goods_spec_a_" + item);
                            spec_radio.attr("checked", "checked");
                            goods_spec_a.addClass('red');
                        })
                    }
                })
            }
        } else {
            initFirstSpec();
        }
    }

    function initFirstSpec(){
        $('.choicsel').each(function (i, o) {
            var firstSpecRadio = $(this).find("input[type='radio']").eq(0);
            firstSpecRadio.attr('checked','checked');
            firstSpecRadio.parents('.choic-sel').find('a').eq(0).addClass('red');
        })
    }
    //初始化商品价格库存
    function initGoodsPrice() {
        var goods_id = $('input[name="goods_id"]').val();
        var goods_num = parseInt($('#number').val());
        if (!$.isEmptyObject(spec_goods_price)) {
            var goods_spec_arr = [];
            $("input[name^='goods_spec']").each(function () {
                if($(this).attr('checked') == 'checked'){
                    goods_spec_arr.push($(this).val());
                }
            });
            var spec_key = goods_spec_arr.sort(sortNumber).join('_');  //排序后组合成 key

            if (spec_goods_price[spec_key] != undefined){
                var item_id = spec_goods_price[spec_key]['item_id']
                    , price = spec_goods_price[spec_key]['price']
                    , store_count = spec_goods_price[spec_key]['store_count'];

                $('input[name=item_id]').val(item_id);
                $('input[name=shop_price]').val(price);
                $('input[name=store_count]').val(store_count);

                $("#goods_price").html(price);
                $('#spec_store_count').html(store_count);
            }else{
                $(".goods_price").html(0); //变动价格显示
                $('.spec_store_count').html(0);
                $("#goods_price").html(0); //变动价格显示
                $("#price").html(0); //变动价格显示
                $('#spec_store_count').html(0);
                joinCart(false);
                return false;
            }
        }
        $.ajax({
            type: 'post',
            dataType: 'json',
            data: {goods_id: goods_id, item_id: item_id, goods_num : goods_num},
            url: "{:U('Mobile/Goods/activity')}",
            success: function (data) {
                if (data.status == 1) {
                    $('input[name="goods_prom_type"]').attr('value', data.result.goods.prom_type);//商品活动类型
                    $('input[name="shop_price"]').attr('value', data.result.goods.shop_price);//商品价格
                    $('input[name="store_count"]').attr('value', data.result.goods.store_count);//商品库存
                    $('input[name="market_price"]').attr('value', data.result.goods.market_price);//商品原价
                }
            }
        });
    }
</script>
</html>